<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch</title>

    <link rel="stylesheet" th:href="@{/movie-page.css}" />
    <link rel="stylesheet" th:href="@{/overlays.css}" />
    <link rel="icon" type="image/x-icon" th:href="@{/cinematch-favicon.ico}">
</head>
<body>

<main id="main-container">
    <section id="logo"> <!-- row 1 -->
        <a th:href="@{/movies}">
            <img th:src="@{/cinematch-logo.png}" alt="CineMatch logo">
        </a>
    </section>

    <section id="movie-information-container"> <!-- row 2 --> <!--grid 2 columns, 1 row-->
        <article id="movie-poster">
            <img th:src="${posterUrl}" alt="back to homepage"/>
        </article>  <!-- col 1 -->

        <article id="movie-details"><!--col 2--> <!-- flexbox align col-->

            <article id="title-container">
                <p id="movie-title" th:text="${title}"></p>
                <a id="back-button" class="link-as-button" th:href="@{'/movies#movie-' + ${movieDetail.id}}">back to movies</a>
            </article>

            <article id="colour-palette-group">
                <p id="colour-palette-heading">colour palettes</p>

                <div class="colour-palette" id="palette-1" th:if="${coloursArray != null}">
                    <div class="colour-box"
                         th:each="colour : ${coloursArray}"
                         th:style="'background-color:' + ${colour}">
                    </div>
                </div>

                <div class="colour-palette" id="palette-2" th:if="${secondaryColours != null}">
                    <div class="colour-box"
                             th:each="colour : ${secondaryColours}"
                             th:style="'background-color:' + ${colour}">
                    </div>
                </div>
            </article>

        </article>
    </section>

    <section id="visualiser-container"> <!-- row 3--> <!-- grid box 2 columns, 2 rows-->
        <p id="visualiser-heading">Turn your room into a masterpiece â€” see it in Dulux</p> <!-- span col 1-2, row 1-->

        <article id="dulux-colours-container"> <!-- row 2 col 1--> <!-- flexbox -->
            <div id="matched-colour-palette" th:with="seenColours=${new java.util.HashSet()}" th:if="${closestMatches != null}">
                <div th:each="match : ${closestMatches}"
                     th:if="${seenColours.add(match.hexCode)}"
                     style="display: inline-block;">

                    <div class="matched-colour-box"
                         th:style="'background-color:' + ${match.hexCode}">
                        <button class="style-button"
                                type="button"
                                th:attr="data-colour=${match.hexCode}"
                                onclick="tryPaintA(this)">
                            Theme A
                        </button>

                        <button class="style-button"
                                type="button"
                                th:attr="data-colour=${match.hexCode}"
                                onclick="tryPaintB(this)">
                            Theme B
                        </button>
                    </div>

                    <a class="dulux-buy-link link-as-button"
                       th:href="${match.purchaseUrl}"
                       th:if="${match.purchaseUrl != null}"
                       target="_blank">
                        buy
                    </a>
                </div>
            </div>

            <!---second matched palette -->
            <div id="secondary-matched-colour-palette" th:with="seenColours=${new java.util.HashSet()}" th:if="${closestSecondaryMatches != null}">
                <div th:each="match : ${closestSecondaryMatches}"
                         th:if="${seenColours.add(match.hexCode)}"
                         style="display: inline-block;">
                    <div class="matched-colour-box"
                         th:style="'background-color:' + ${match.hexCode}">
                        <button class="style-button"
                                type="button"
                                th:attr="data-colour=${match.hexCode}"
                                onclick="tryPaintA(this)">
                            Theme A
                        </button>

                        <button class="style-button"
                                type="button"
                                th:attr="data-colour=${match.hexCode}"
                                onclick="tryPaintB(this)">
                            Theme B
                        </button>
                    </div>

                    <a class="dulux-buy-link link-as-button"
                       th:href="${match.purchaseUrl}"
                       th:if="${match.purchaseUrl != null}"
                       target="_blank">
                        buy
                    </a>
                </div>
            </div>
        </article>

        <article id="room-container"> <!-- row 2 col 2 --> <!--flexbox-->
            <div id="button-menu">
                <button id="room-selector">change room</button>
                <button id="reset-button"
                        type="button"
                        onclick="resetpaint()">
                    reset
                </button>
            </div>

            <div class="bedroom-preview" id="room-1">
                <img th:src="@{/Images/bedroom/Base_image.jpg}" class="bedroom-base" alt="Bedroom">

                <div id="bedroom-overlay" class="mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/Mask_Ceiling.png} + '); mask-image:url(' + @{/Images/bedroom/Mask_Ceiling.png} + ');'"
                     th:styleappend="'transform: translateX(-0.3%);'">
                </div>

                <div id="wall-overlay" class="mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/Mask_Wall-1.png} + '); mask-image:url(' + @{/Images/bedroom/Mask_Wall-1.png} + ');'"
                     th:styleappend="'transform: translateX(-0.8%);'">
                </div>

                <div id="wall2-overlay" class="mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/Mask_Wall-2.png} + '); mask-image:url(' + @{/Images/bedroom/Mask_Wall-2.png} + ');'"
                     th:styleappend="'transform: translateX(-0.8%);'">
                </div>

                <div id="nightstand-overlay" class="mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/Mask_Nightstand.png} + '); mask-image:url(' + @{/Images/bedroom/Mask_Nightstand.png} + ');'"
                     th:styleappend="'transform: translateX(0.4%);'">
                </div>
            </div>

            <div class="bedroom-preview" id="room-2">
                <img th:src="@{/Images/bedroom/bedroom2/Poster_room_original.jpg}" class="bedroom-base" />

                <div id="bedroom2-wall1-overlay"
                     class = "mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Wall-1.png} + ');
                        mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Wall-1.png} + ');'">
                </div>
                <div id="bedroom2-wall2-overlay"
                     class = "mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Wall-2.png} + ');
                        mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Wall-2.png} + ');'">
                </div>
                <div id="bedroom2-ceiling-overlay"
                     class = "mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Ceiling.png} + ');
                        mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_room_Ceiling.png} + ');'">
                </div>
                <div id="bedroom2-coving-overlay"
                     class = "mask_overlay"
                     th:style="'-webkit-mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_Room_Coving.png} + ');
                        mask-image:url(' + @{/Images/bedroom/bedroom2/Poster_Room_Coving.png} + ');'">
                </div>
                <img id="poster-mask" th:src="${posterUrl}"
                     style="position: absolute; top: 30.25%; left: 35%; width: 29%; height: 25.5%; z-index: 10; object-fit: cover;" />
            </div>
        </article>
    </section>

    <section id="e-commerce-container"> <!-- row 3 --> <!-- flex box -->
        <p id="e-commerce-heading">Bring your favourite scenes home</p>
        <div id="redbubble-section" style="display: none;">
            <div id="redbubble-container"></div>
        </div>
    </section>

    <section id="recommendations-container" th:if="${recommendedMovies != null}"> <!-- row 5 -->
        <p id="recommendations-heading">More movies with similar palettes</p>

        <article id="recommended-movies-flexbox">
            <div class="recommended-movie"
                 th:each="movie : ${recommendedMovies}"
                 th:if="${movie.posterUrl != null}">

                <a th:href="@{/movies/{id}(id=${movie.id})}">
                    <img th:src="${movie.posterUrl}"
                         th:alt="${movie.title + ' poster'}"
                         class="recommended-poster" />

                    <div class="movie-info-overlay">
                        <div class="dominant-colour-indicator"
                             th:style="'background-color:' + ${movie.dominantColour}"
                             th:if="${movie.dominantColour != null}">
                        </div>
                    </div>
                </a>
            </div>
        </article>
    </section>

    <script>
        //SCRIPT FOR VISUALISER MASKS
        function tryPaintA(button) {
            const colour = button.getAttribute("data-colour");

            // Room 1 overlays
            const room1 = document.getElementById("room-1");
            if (room1.style.display !== "none") {
                const ceiling = document.getElementById("bedroom-overlay");
                const wall1 = document.getElementById("wall-overlay");
                if (ceiling) ceiling.style.backgroundColor = colour;
                if (wall1) wall1.style.backgroundColor = colour;
            }

            // Room 2 overlays
            const room2 = document.getElementById("room-2");
            if (room2.style.display !== "none") {
                const ceiling2 = document.getElementById("bedroom2-ceiling-overlay");
                const wall21 = document.getElementById("bedroom2-wall1-overlay");
                if (ceiling2) ceiling2.style.backgroundColor = colour;
                if (wall21) wall21.style.backgroundColor = colour;
            }
        }

        function tryPaintB(button) {
            const colour = button.getAttribute("data-colour");

            // Room 1 overlays
            const room1 = document.getElementById("room-1");
            if (room1.style.display !== "none") {
                const nightstand = document.getElementById("nightstand-overlay");
                const wall2 = document.getElementById("wall2-overlay");
                if (nightstand) nightstand.style.backgroundColor = colour;
                if (wall2) wall2.style.backgroundColor = colour;

            }

            // Room 2 overlays
            const room2 = document.getElementById("room-2");
            if (room2.style.display !== "none") {
                const coving2 = document.getElementById("bedroom2-coving-overlay");
                const wall22 = document.getElementById("bedroom2-wall2-overlay");
                if (coving2) coving2.style.backgroundColor = colour;
                if (wall22) wall22.style.backgroundColor = colour;
            }
        }
        function resetpaint() {
            // Room 1 overlays
            const ceiling = document.getElementById("bedroom-overlay");
            const wall1 = document.getElementById("wall-overlay");
            const nightstand = document.getElementById("nightstand-overlay");
            const wall2 = document.getElementById("wall2-overlay");
            if (room1 && room1.style.display !== "none") {
                const nightstand = document.getElementById("nightstand-overlay");
                const wall2 = document.getElementById("wall2-overlay");
                if (ceiling) ceiling.style.backgroundColor = "";
                if (wall1) wall1.style.backgroundColor = "";
                if (nightstand) nightstand.style.backgroundColor = "";
                if (wall2) wall2.style.backgroundColor = "";

            }

            // Room 2 overlays
            const ceiling2 = document.getElementById("bedroom2-ceiling-overlay");
            const wall21 = document.getElementById("bedroom2-wall1-overlay");
            const coving2 = document.getElementById("bedroom2-coving-overlay");
            const wall22 = document.getElementById("bedroom2-wall2-overlay");
            if (room2 && room2.style.display !== "none") {
                const coving2 = document.getElementById("bedroom2-coving-overlay");
                const wall22 = document.getElementById("bedroom2-wall2-overlay");
                if (ceiling2) ceiling2.style.backgroundColor = "";
                if (wall21) wall21.style.backgroundColor = "";
                if (coving2) coving2.style.backgroundColor = "";
                if (wall22) wall22.style.backgroundColor = "";

            }
        }

        //SCRIPT FOR VISUALISER BUTTONS
        const colourBoxes = document.querySelectorAll('.matched-colour-box');
        colourBoxes.forEach(box => {
            const buttons = box.querySelectorAll('.style-button');

            // buttons initially set to display none
            buttons.forEach(btn => btn.style.display = 'none');

            // reveal buttons on hover and display none when no longer hovering
            box.addEventListener('mouseenter', () => {
                buttons.forEach(btn => btn.style.display = 'inline-block');
            });

            box.addEventListener('mouseleave', () => {
                buttons.forEach(btn => btn.style.display = 'none');
            });
        });

        //SCRIPT FOR TOGGLING ROOM PREVIEWS
        const roomButton = document.getElementById('room-selector');
        const room1 = document.getElementById('room-1');
        const room2 = document.getElementById('room-2');

        // start off with room 1 on show, room 2 hidden
        room1.style.display = 'block';
        room2.style.display = 'none';

        // toggle rooms
        roomButton.addEventListener('click', () => {
            if (room1.style.display === 'block') {
                room1.style.display = 'none';
                room2.style.display = 'block';
            } else {
                room1.style.display = 'block';
                room2.style.display = 'none';
            }
        });



    document.addEventListener('DOMContentLoaded', function() {
        const movieTitle = document.getElementById('movie-title').textContent;
        const redBubbleSection = document.getElementById('redbubble-section');
        const redBubbleContainer = document.getElementById('redbubble-container');

        // Fetch RedBubble search info
        fetch(`/api/redbubble/search?query=${encodeURIComponent(movieTitle)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                redBubbleSection.style.display = 'block';

                redBubbleContainer.innerHTML = `
                    <div class="redbubble-link-container">
                        <h3>Shop Related Items</h3>
                        <p>Looking for ${movieTitle} merchandise?</p>
                        <a href="${data.searchUrl}" target="_blank" class="redbubble-link">
                            <span class="redbubble-logo">RedBubble</span>
                            <span class="link-text">${data.searchText}</span>
                            <span class="external-link-icon">â†—</span>
                        </a>
                    </div>
                `;
            })
            .catch(error => {
                // Fallback - create the link without API call
                const fallbackUrl = `https://www.redbubble.com/shop?query=${encodeURIComponent(movieTitle)}`;
                redBubbleSection.style.display = 'block';
                redBubbleContainer.innerHTML = `
                    <div class="redbubble-link-container">
                        <h3>Shop Related Items</h3>
                        <a href="${fallbackUrl}" target="_blank" class="redbubble-link">
                            <span class="redbubble-logo">RedBubble</span>
                            <span class="link-text">Find ${movieTitle} merchandise</span>
                            <span class="external-link-icon">â†—</span>
                        </a>
                    </div>
                `;
                console.error('Error fetching RedBubble info:', error);
            });
    });
    </script>

</main>
</body>
</html>